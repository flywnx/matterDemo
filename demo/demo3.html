<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>正式尝试飞刀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="../matter.min.js"></script>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
      background-color: #fff;
    }
  </style>
</head>

<body>

</body>
<script>
  -function () {
    // 初始化定义
    // 引擎
    let Engine = Matter.Engine,
      // 渲染
      Render = Matter.Render,
      // 运动
      Runner = Matter.Runner,
      // 鼠标约束
      MouseConstraint = Matter.MouseConstraint,
      // 鼠标
      Mouse = Matter.Mouse,
      // 世界
      World = Matter.World,
      // 主体配置
      Bodies = Matter.Bodies,
      // 操纵体模型
      Body = Matter.Body,
      // 复合材料
      Composites = Matter.Composites,
      // 约束
      Constraint = Matter.Constraint,
      // 事件
      Events = Matter.Events
    // 创建引擎,世界
    let engine = Engine.create(),
      world = engine.world
    // 渲染世界
    let render = Render.create({
      element: document.body,
      engine: engine,
      options: {
        width: 800,
        height: 600,
        // 速度显示
        showVelocity: true
      }
    })
    // 执行渲染
    Render.run(render);

    //创建动作
    var runner = Runner.create();
    Runner.run(runner, engine);
    // 添加物体

    // 树状
    var tree = Bodies.rectangle(60, 560, 60, 60, {
      id: 'tree',
      isStatic: true,
      stiffness: 0.8,
      collisionFilter: {
        category: 1,
      },
    });
    // 刀
    var knife = Bodies.rectangle(60, 490, 20, 80, {
      id: 'knife',
      stiffness: 1,
      restitution: 0.3,

      collisionFilter: {
        category: 3,
      },
      applyForce: {

      }
    });
    // 杆子
    var pole = Bodies.rectangle(680, 340, 20, 500, {
      id: 'pole',
      isStatic: true,
      stiffness: 0.8,

      collisionFilter: {
        category: 1,
      },
    });

    // 靶子
    var target = Bodies.rectangle(680, 340, 60, 60, {
      id: 'target',
      stiffness: 0.8,
      collisionFilter: {
        category: 2,
      }, isStatic: true
    });

    // 地面
    var ground = Bodies.rectangle(400, 600, 800, 20, {
      id: 'ground',
      isStatic: true,
      stiffness: 1,
      collisionFilter: {
        category: 1,
      },
    });
    // 为世界添加物体
    World.add(world, [tree, ground, knife, target, pole]);

    // 初始化鼠标控制
    let mouse = Mouse.create(render.canvas),
      mouseConstraint = MouseConstraint.create(engine, {
        mouse: mouse,
        constraint: {
          // 刚度
          stiffness: 1,
          render: {
            visible: true
          }
        }
      })

    // 碰撞开始监听
    Events.on(engine, 'collisionStart', (event) => {
      // console.log('碰撞开始')
      // console.log([...event.pairs]);
      let cs = [...event.pairs][0][`id`].split('_')

      // 刀与靶碰撞，刀就静止
      if (cs[0] == 'knife' && cs[1] == 'target') {
        knife.isSleeping = true
      }


    })
    // Body.applyForce = function (body, position, force) {
    //   body.force.x += force.x;
    //   body.force.y += force.y;
    //   var offset = { x: position.x - body.position.x, y: position.y - body.position.y };
    //   body.torque += offset.x * force.y - offset.y * force.x;
    // };
    // Body.applyForce(knife, [x: 60, y: 490 ], [x: 60, y: 490 ]);
    World.add(world, mouseConstraint);
    //  保持鼠标与渲染同步
    render.mouse = mouse;
    // 将渲染视口安装到场景中
    // Render.lookAt(render, {
    //   min: { x: 0, y: 0 },
    //   max: { x: 800, y: 600 }
    // });
    return {
      engine: engine,
      runner: runner,
      render: render,
      canvas: render.canvas,
      stop: function () {
        Matter.Render.stop(render);
        Matter.Runner.stop(runner);
      }
    };
  }()
</script>

</html>